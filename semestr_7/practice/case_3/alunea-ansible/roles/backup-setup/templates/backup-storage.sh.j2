#!/usr/bin/env bash
set -euo pipefail

SOURCE_DIR="/opt/alunea/alunea-backend/var/storage"
BACKUP_DIR="/opt/alunea/backups/storage"
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
BACKUP_FILE_PATH="${BACKUP_DIR}/backup.storage.${TIMESTAMP}.tar.gz"

# Делаем архив
if tar -zcvf "${BACKUP_FILE_PATH}" "${SOURCE_DIR}"; then
  echo "[$(date)] ✅ Backup created: ${BACKUP_FILE_PATH}"
else
  echo "[$(date)] ❌ Backup failed!" >&2
  exit 1
fi

find "${BACKUP_DIR}" -type f -name "backup.storage.*.tar.gz" -mtime +14 -print -delete
